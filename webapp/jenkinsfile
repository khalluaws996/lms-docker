pipeline {
    agent any

    environment {
        repositoryURL = "http://54.172.190.173:8081/repository/lms/"
        downloadDirectory = "/tmp" // Specify a different directory for artifact download
        deploymentLocation = "/home/ubuntu/lms" // Specify the deployment location
        artifactFileName = "your-artifact-file.zip" // Specify the name of the artifact file
        credentialsId = 'repo-credentials' // Specify the ID of the Jenkins credentials containing the username and password
    }

    stages {
        stage('Cleanup Workspace') {
            steps {
                deleteDir()
            }
        }
        
        stage('Checkout Code') {
            steps {
                checkout scm
            }
        }

        stage('Build LMS') {
            steps {
                echo 'Building LMS...'
                sh '''
                   cd webapp
                   npm install
                   npm run build
                '''
            }
        }

        stage('Publish Artifacts') {
            steps {
                script {
                    echo "Publishing artifacts"
                    
                    // Read the version from package.json
                    def packageJSON = readJSON file: 'webapp/package.json'
                    def packageJSONVersion = packageJSON.version 
                    
                    // Create a zip file of the dist directory
                    def zipFileName = "webapp/dist-${packageJSONVersion}.zip"
                    sh "zip -r ${zipFileName} webapp/dist/*"
                    
                    // Upload the zip file to the repository
                    def curlCommand = "curl -v -u admin:admin123 --upload-file ${zipFileName} ${repositoryURL}${zipFileName}"
                    
                    // Retry mechanism
                    def maxRetries = 6
                    def retryCount = 0
                    def success = false

                    while (retryCount < maxRetries && !success) {
                        try {
                            sh curlCommand
                            success = true
                        } catch (Exception e) {
                            echo "Upload attempt ${retryCount + 1} failed. Retrying..."
                            echo "Error: ${e}"
                            retryCount++
                            sleep(time: 10, unit: 'SECONDS') // Wait before retrying
                        }
                    }

                    if (!success) {
                        error("Failed to upload the artifact after ${maxRetries} attempts")
                    }
                }
            }
        }

        stage('Download Artifact') {
            steps {
                echo 'Downloading artifact...'
                withCredentials([usernamePassword(credentialsId: 'repo-credentials', usernameVariable: 'USERNAME', passwordVariable: 'PASSWORD')]) {
                    sh "wget --user=${USERNAME} --password=${PASSWORD} -O ${downloadDirectory}/${artifactFileName} ${repositoryURL}/${artifactFileName}"
                }
            }
        }
        
        stage('Deploy LMS') {
            when {
                expression {
                    currentBuild.result != 'FAILURE' // Run only if there are no failures in earlier stages
                }
            }
            steps {
                echo 'Deploying LMS...'
                sh "ls -l ${downloadDirectory}/${artifactFileName}" // Verify artifact existence
                sh "unzip -o ${downloadDirectory}/${artifactFileName} -d ${deploymentLocation}"
                sh "${deploymentLocation}/start.sh" // Assuming start.sh script exists for starting the LMS
            }
        }
    }
    
    post {
        always {
            // Clean up any temporary files or resources if needed
            cleanWs()
        }
    }
}
